"""
Unit tests for the Word2Vec class.
"""
import os
import gensim
import unittest
import psycopg2

from isoweek import Week
from pathlib import Path

from skill.skill import Crypto
from skill.word2vec import Model
from skill.storage import Storage
from skill.bitcointalk import BitcoinTalk


class Word2VecTestCase(unittest.TestCase):
    """
    Test case for the Model() class.
    """
    @classmethod
    def setUpClass(self):
        sql = """
        INSERT INTO "public"."message"("sid","topic","topic_position","member","post_time","subject","link","content","content_no_html","content_no_quote","content_no_quote_no_html","db_update_time")
            VALUES
            (1000000000,34,1,28,E'2010-02-01 02:17:02',E'Questions about Addresses',E'https://bitcointalk.org/index.php?topic=34.msg185#msg185',E'\\x3129205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f20616e204950206164647265737320746861742069736e27742072756e6e696e67207468652070726f6772616d3f3c62723e3229205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f206120696e76616c696420426974636f696e20416464726573733f3c62723e3329205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f206120426974636f696e20416464726573732074686174206e6f626f6479206f776e733f3c62723e3429205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f206120426974636f696e20416464726573732074686174207573656420746f206265206f776e65642c20627574206861732073696e6365206265656e206162616e646f6e65642028726563697069656e742073746f707065642072756e6e696e67207468652070726f6772616d2c206f722064656c657465642074686569722077616c6c6574293f3c62723e3c62723e49207468616e6b20616e7377657265727320666f7220657870616e64696e67206d79206b6e6f776c656467652e',E'1) What would happen if one attempts to send an amount of coins to an IP address that isn t running the program?2) What would happen if one attempts to send an amount of coins to a invalid Bitcoin Address?3) What would happen if one attempts to send an amount of coins to a Bitcoin Address that nobody owns?4) What would happen if one attempts to send an amount of coins to a Bitcoin Address that used to be owned, but has since been abandoned (recipient stopped running the program, or deleted their wallet)?I thank answerers for expanding my knowledge.',E'\\x3129205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f20616e204950206164647265737320746861742069736e27742072756e6e696e67207468652070726f6772616d3f3c62723e3229205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f206120696e76616c696420426974636f696e20416464726573733f3c62723e3329205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f206120426974636f696e20416464726573732074686174206e6f626f6479206f776e733f3c62723e3429205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f206120426974636f696e20416464726573732074686174207573656420746f206265206f776e65642c20627574206861732073696e6365206265656e206162616e646f6e65642028726563697069656e742073746f707065642072756e6e696e67207468652070726f6772616d2c206f722064656c657465642074686569722077616c6c6574293f3c62723e3c62723e49207468616e6b20616e7377657265727320666f7220657870616e64696e67206d79206b6e6f776c656467652e',E'1) What would happen if one attempts to send an amount of coins to an IP address that isn t running the program?2) What would happen if one attempts to send an amount of coins to a invalid Bitcoin Address?3) What would happen if one attempts to send an amount of coins to a Bitcoin Address that nobody owns?4) What would happen if one attempts to send an amount of coins to a Bitcoin Address that used to be owned, but has since been abandoned (recipient stopped running the program, or deleted their wallet)?I thank answerers for expanding my knowledge.',NULL),
            (1000000001,34,2,4,E'2010-02-01 10:44:43',E'Re: Questions about Addresses',E'https://bitcointalk.org/index.php?topic=34.msg187#msg187',E'\\x3c64697620636c6173733d2271756f7465686561646572223e3c6120687265663d2268747470733a2f2f626974636f696e74616c6b2e6f72672f696e6465782e7068703f746f7069633d33342e6d7367313835236d7367313835223e51756f74652066726f6d3a20536162756e6972206f6e2046656272756172792030312c20323031302c2030323a31373a303220414d3c2f613e3c2f6469763e3c64697620636c6173733d2271756f7465223e3129205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f20616e204950206164647265737320746861742069736e27742072756e6e696e67207468652070726f6772616d3f3c62723e3229205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f206120696e76616c696420426974636f696e20416464726573733f3c62723e3c2f6469763e3c62723e4e6f7420706f737369626c652c2074686520736f66747761726520646f65736e277420616c6c6f7720746861742e3c62723e3c62723e3c64697620636c6173733d2271756f7465686561646572223e51756f74653c2f6469763e3c64697620636c6173733d2271756f7465223e3329205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f206120426974636f696e20416464726573732074686174206e6f626f6479206f776e733f3c62723e3429205768617420776f756c642068617070656e206966206f6e6520617474656d70747320746f2073656e6420616e20616d6f756e74206f6620636f696e7320746f206120426974636f696e20416464726573732074686174207573656420746f206265206f776e65642c20627574206861732073696e6365206265656e206162616e646f6e65642028726563697069656e742073746f707065642072756e6e696e67207468652070726f6772616d2c206f722064656c657465642074686569722077616c6c6574293f3c62723e3c2f6469763e3c62723e4920677565737320746865206d6f6e65792077696c6c206a757374206265206c6f737420696e207468617420636173652e',E'Quote from: Sabunir on February 01, 2010, 02:17:02 AM1) What would happen if one attempts to send an amount of coins to an IP address that isn t running the program?2) What would happen if one attempts to send an amount of coins to a invalid Bitcoin Address?Not possible, the software doesn t allow that.Quote3) What would happen if one attempts to send an amount of coins to a Bitcoin Address that nobody owns?4) What would happen if one attempts to send an amount of coins to a Bitcoin Address that used to be owned, but has since been abandoned (recipient stopped running the program, or deleted their wallet)?I guess the money will just be lost in that case.',E'\\x3c62723e4e6f7420706f737369626c652c2074686520736f66747761726520646f65736e277420616c6c6f7720746861742e3c62723e3c62723e3c62723e4920677565737320746865206d6f6e65792077696c6c206a757374206265206c6f737420696e207468617420636173652e',E'Not possible, the software doesn t allow that.I guess the money will just be lost in that case.',NULL),
            (1000000002,34,3,30,E'2010-02-01 23:10:07',E'Re: Questions about Addresses',E'https://bitcointalk.org/index.php?topic=34.msg196#msg196',E'\\x576861742068617070656e7320746f20426974636f696e732073656e7420746f20616e204950206164647265737320776865726520746865207375622d6e657420636f6d7075746572732061726520656163682072756e6e696e6720426974636f696e20736f667477617265203f203c696d67207372633d2268747470733a2f2f626974636f696e74616c6b2e6f72672f536d696c6579732f64656661756c742f6875682e6769662220616c743d224875682220626f726465723d2230223e3c62723e3c62723e446f207468657920616c6c207265636569766520616e20657175616c207368617265206f6620426974636f696e73203f206c6f6c203c696d67207372633d2268747470733a2f2f626974636f696e74616c6b2e6f72672f536d696c6579732f64656661756c742f726f6c6c657965732e6769662220616c743d22526f6c6c20457965732220626f726465723d2230223e',E'What happens to Bitcoins sent to an IP address where the sub-net computers are each running Bitcoin software ? Do they all receive an equal share of Bitcoins ? lol ',E'\\x576861742068617070656e7320746f20426974636f696e732073656e7420746f20616e204950206164647265737320776865726520746865207375622d6e657420636f6d7075746572732061726520656163682072756e6e696e6720426974636f696e20736f667477617265203f203c696d67207372633d2268747470733a2f2f626974636f696e74616c6b2e6f72672f536d696c6579732f64656661756c742f6875682e6769662220616c743d224875682220626f726465723d2230223e3c62723e3c62723e446f207468657920616c6c207265636569766520616e20657175616c207368617265206f6620426974636f696e73203f206c6f6c203c696d67207372633d2268747470733a2f2f626974636f696e74616c6b2e6f72672f536d696c6579732f64656661756c742f726f6c6c657965732e6769662220616c743d22526f6c6c20457965732220626f726465723d2230223e',E'What happens to Bitcoins sent to an IP address where the sub-net computers are each running Bitcoin software ? Do they all receive an equal share of Bitcoins ? lol ',NULL),
            (1000000003,34,4,26,E'2010-02-01 23:41:24',E'Re: Questions about Addresses',E'https://bitcointalk.org/index.php?topic=34.msg197#msg197',E'\\x496620492072656d656d62657220636f72726563746c792049207468696e6b20492077617320746f6c642074686174207468657920776f756c642062652073656e7420746f2074686520666972737420626974636f696e206170706c69636174696f6e20776974682077686f6d207468652073656e64657220636f6e6e656374732e',E'If I remember correctly I think I was told that they would be sent to the first bitcoin application with whom the sender connects.',E'\\x496620492072656d656d62657220636f72726563746c792049207468696e6b20492077617320746f6c642074686174207468657920776f756c642062652073656e7420746f2074686520666972737420626974636f696e206170706c69636174696f6e20776974682077686f6d207468652073656e64657220636f6e6e656374732e',E'If I remember correctly I think I was told that they would be sent to the first bitcoin application with whom the sender connects.',NULL)
        """
        with Storage(os.getenv('POSTGRES_URI')) as S:
            try:
                S.execute(sql)
            except psycopg2.IntegrityError:
                S.execute("""
                DELETE FROM message
                    WHERE sid IN (1000000000, 1000000001, 1000000002, 1000000003)
                """)
    
    @classmethod
    def tearDownClass(self):
        with Storage(os.getenv('POSTGRES_URI')) as S:
            S.execute("""
                DELETE FROM message
                    WHERE sid IN (1000000000, 1000000001, 1000000002, 1000000003)
                """)
    

    def test_corpus_create(self):
        """
        Model()._corpus_create() can create a properly cleaned corpus from an 
        input from the BitcoinTalk() class.
        """
        unclean = BitcoinTalk().all()
        results = Model()._corpus_create(unclean)

        for result in results:
            assert type(result) == list
            assert len(result) >= 3

    def test_training_pipeline(self):
        """
        Model().train is able to train a model and place it 
        in the proper directory.
        """
        #
        #  The original Word2Vec requires that words
        #  appear at least 5 times by default. Here 
        #  we pass the argument min_count=1 because
        #  our test test does not contain words that
        #  repeat 5 times.
        #
        path = os.getenv('MODELS_PATH')
        trained = Model().train(
            directory=path, data_last_week=False, epochs=1,
            min_count=1)

        last_week = str(Week.thisweek() - 1)

        my_trained_file = Path(f'{path}/{last_week}.model')

        assert my_trained_file.is_file()
        assert type(trained) == gensim.models.word2vec.Word2Vec
